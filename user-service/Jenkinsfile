pipeline {
    agent any
    
    environment {
        // Java Configuration
        JAVA_HOME = '/usr/lib/jvm/java-17-openjdk-amd64'
        PATH = "/root/google-cloud-sdk/bin:${JAVA_HOME}/bin:${env.PATH}"
        
        // GCP & Kubernetes
        USE_GKE_GCLOUD_AUTH_PLUGIN = 'True'
        K8S_NAMESPACE = 'ecommerce-staging'
        
        // Service Configuration
        SERVICE_NAME = 'user-service'
        SERVICE_PORT = '8700'
        
        // Build
        MAVEN_OPTS = '-Xmx2048m'
        BUILD_TAG = "${env.BUILD_NUMBER}"
    }
    
    parameters {
        booleanParam(
            name: 'SKIP_TESTS',
            defaultValue: false,
            description: 'Saltar pruebas unitarias'
        )
        booleanParam(
            name: 'DEPLOY_TO_K8S',
            defaultValue: true,
            description: 'Desplegar en Kubernetes'
        )
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo "üîÑ Clonando repositorio de ${SERVICE_NAME}..."
                checkout scm
            }
        }
        
        stage('Build Service') {
            steps {
                script {
                    echo "üî® Compilando ${SERVICE_NAME}..."
                    def testFlag = params.SKIP_TESTS ? '-DskipTests' : ''
                    // Cambiar al directorio del servicio y compilar
                    dir('user-service') {
                        sh "mvn clean package ${testFlag}"
                    }
                }
            }
        }
        
        stage('Unit Tests') {
            when {
                expression { params.SKIP_TESTS == false }
            }
            steps {
                script {
                    echo "üß™ Ejecutando pruebas unitarias de ${SERVICE_NAME}..."
                    dir('user-service') {
                        sh 'mvn test'
                    }
                }
            }
            post {
                always {
                    junit allowEmptyResults: true, testResults: 'user-service/target/surefire-reports/*.xml'
                }
            }
        }
        
        stage('Build Docker Image') {
            steps {
                script {
                    echo "üê≥ Construyendo imagen Docker de ${SERVICE_NAME}..."
                    dir('user-service') {
                        sh """
                            docker build -t ${SERVICE_NAME}:${BUILD_TAG} -f Dockerfile .
                            docker tag ${SERVICE_NAME}:${BUILD_TAG} ${SERVICE_NAME}:latest
                        """
                    }
                }
            }
        }
        
        stage('Deploy to Kubernetes') {
            when {
                expression { params.DEPLOY_TO_K8S == true }
            }
            steps {
                script {
                    echo "‚ò∏Ô∏è Desplegando ${SERVICE_NAME} en Kubernetes..."
                    
                    sh """
                        . /root/google-cloud-sdk/path.bash.inc
                        
                        # Crear namespace si no existe
                        kubectl create namespace ${K8S_NAMESPACE} --dry-run=client -o yaml | kubectl apply -f -
                        
                        # Aplicar deployment
                        kubectl apply -f k8s/microservices/${SERVICE_NAME}-deployment.yaml -n ${K8S_NAMESPACE}
                        
                        # Verificar deployment
                        kubectl rollout status deployment/${SERVICE_NAME} -n ${K8S_NAMESPACE} --timeout=180s || echo "‚ö†Ô∏è ${SERVICE_NAME} no est√° listo"
                    """
                }
            }
        }
        
        stage('Integration Tests') {
            when {
                expression { params.DEPLOY_TO_K8S == true }
            }
            steps {
                script {
                    echo "üß™ Ejecutando pruebas de integraci√≥n de ${SERVICE_NAME}..."
                    
                    sh """
                        . /root/google-cloud-sdk/path.bash.inc
                        
                        echo "Verificando estado del pod..."
                        kubectl get pods -n ${K8S_NAMESPACE} -l app=${SERVICE_NAME}
                        
                        POD_STATUS=\$(kubectl get pods -n ${K8S_NAMESPACE} -l app=${SERVICE_NAME} -o jsonpath='{.items[0].status.phase}' 2>/dev/null || echo 'NotFound')
                        echo "Estado del pod: \$POD_STATUS"
                        
                        if [ "\$POD_STATUS" = "Running" ]; then
                            echo "‚úÖ ${SERVICE_NAME} est√° corriendo correctamente"
                        else
                            echo "‚ö†Ô∏è WARNING: ${SERVICE_NAME} no est√° en estado Running"
                            exit 1
                        fi
                        
                        echo "Verificando servicio..."
                        kubectl get svc -n ${K8S_NAMESPACE} ${SERVICE_NAME}
                    """
                }
            }
        }
    }
    
    post {
        always {
            echo "üßπ Limpiando workspace..."
            cleanWs()
        }
        success {
            echo "‚úÖ Pipeline de ${SERVICE_NAME} ejecutado exitosamente"
            echo "üöÄ ${SERVICE_NAME} desplegado en namespace: ${K8S_NAMESPACE}"
        }
        failure {
            echo "‚ùå Pipeline de ${SERVICE_NAME} fall√≥"
        }
    }
}
