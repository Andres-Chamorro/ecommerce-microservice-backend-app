name: ðŸš€ Generate Release Notes

on:
  push:
    tags:
      - '*-v*.*.*'  # Matches: user-service-v1.0.0, order-service-v2.1.0, etc.

permissions:
  contents: write
  pull-requests: read

jobs:
  generate-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for changelog generation
      
      - name: ðŸ” Extract service name and version from tag
        id: extract
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          echo "Full tag: $TAG_NAME"
          
          # Extract service name and version
          # Example: user-service-v1.0.0 -> service=user-service, version=1.0.0
          SERVICE_NAME=$(echo $TAG_NAME | sed 's/-v[0-9].*//')
          VERSION=$(echo $TAG_NAME | sed 's/.*-v//')
          
          echo "service=$SERVICE_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          
          echo "ðŸ“¦ Service: $SERVICE_NAME"
          echo "ðŸ·ï¸  Version: $VERSION"
      
      - name: ðŸ“ Generate Release Notes
        id: release_notes
        run: |
          SERVICE="${{ steps.extract.outputs.service }}"
          VERSION="${{ steps.extract.outputs.version }}"
          TAG="${{ steps.extract.outputs.tag }}"
          
          # Get previous tag for this service
          PREV_TAG=$(git tag -l "${SERVICE}-v*" --sort=-version:refname | sed -n '2p')
          
          # Create release notes file
          cat > release-notes.md << EOF
          # ðŸš€ Release Notes - ${SERVICE} v${VERSION}
          
          ## ðŸ“¦ Release Information
          - **Service**: ${SERVICE}
          - **Version**: v${VERSION}
          - **Release Date**: $(date '+%Y-%m-%d %H:%M:%S UTC')
          - **Tag**: ${TAG}
          - **Environment**: Production
          
          ## ðŸ“‹ What's Changed
          
          EOF
          
          # Generate changelog from commits
          if [ -n "$PREV_TAG" ]; then
            echo "Comparing with previous tag: $PREV_TAG"
            echo "### Commits since ${PREV_TAG}" >> release-notes.md
            echo "" >> release-notes.md
            git log ${PREV_TAG}..${TAG} --pretty=format:"- %s (%h)" --no-merges >> release-notes.md
          else
            echo "### Initial Release" >> release-notes.md
            echo "" >> release-notes.md
            echo "This is the first release of ${SERVICE}" >> release-notes.md
          fi
          
          # Add deployment info
          cat >> release-notes.md << EOF
          
          
          ## ðŸš€ Deployment Details
          - **Docker Image**: \`${SERVICE}:v${VERSION}\`
          - **Kubernetes Namespace**: \`ecommerce-prod\`
          - **Replicas**: 3
          - **Environment**: GKE Production
          
          ## âœ… Quality Gates
          - [x] Unit Tests
          - [x] Integration Tests
          - [x] E2E Tests (Staging)
          - [x] Performance Tests (Staging)
          - [x] Smoke Tests (Production)
          - [x] Security Scans
          
          ## ðŸ“Š Rollback Instructions
          
          If you need to rollback this release:
          
          \`\`\`bash
          kubectl rollout undo deployment/${SERVICE} -n ecommerce-prod
          \`\`\`
          
          Or rollback to a specific version:
          
          \`\`\`bash
          kubectl set image deployment/${SERVICE} ${SERVICE}=<previous-image> -n ecommerce-prod
          \`\`\`
          
          ---
          
          **Generated by**: GitHub Actions  
          **Workflow**: Release Notes Generator  
          **Triggered by**: Tag push \`${TAG}\`
          EOF
          
          echo "âœ… Release notes generated"
          cat release-notes.md
      
      - name: ðŸŽ‰ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.extract.outputs.tag }}
          name: "${{ steps.extract.outputs.service }} v${{ steps.extract.outputs.version }}"
          body_path: release-notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ“¢ Release Summary
        run: |
          echo "## ðŸŽ‰ Release Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Service**: ${{ steps.extract.outputs.service }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: v${{ steps.extract.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ steps.extract.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Release notes have been published to GitHub Releases" >> $GITHUB_STEP_SUMMARY
