pipeline {
    agent any
    
    environment {
        JAVA_HOME = '/usr/lib/jvm/java-17-openjdk-amd64'
        PATH = "/root/google-cloud-sdk/bin:${JAVA_HOME}/bin:${env.PATH}"
        USE_GKE_GCLOUD_AUTH_PLUGIN = 'True'
        K8S_NAMESPACE = 'ecommerce-staging'
        SERVICE_NAME = 'product-service'
        SERVICE_PORT = '8500'
        MAVEN_OPTS = '-Xmx2048m'
        BUILD_TAG = "${env.BUILD_NUMBER}"
    }
    
    parameters {
        booleanParam(name: 'SKIP_TESTS', defaultValue: false, description: 'Saltar pruebas unitarias')
        booleanParam(name: 'DEPLOY_TO_K8S', defaultValue: true, description: 'Desplegar en Kubernetes')
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo "üîÑ Clonando repositorio de ${SERVICE_NAME}..."
                checkout scm
            }
        }
        
        stage('Build Service') {
            steps {
                script {
                    echo "üî® Compilando ${SERVICE_NAME}..."
                    def testFlag = params.SKIP_TESTS ? '-DskipTests' : ''
                    sh "mvn clean package ${testFlag} -pl . -am"
                }
            }
        }
        
        stage('Unit Tests') {
            when { expression { params.SKIP_TESTS == false } }
            steps {
                echo "üß™ Ejecutando pruebas unitarias de ${SERVICE_NAME}..."
                sh 'mvn test -pl . -am'
            }
            post {
                always {
                    junit allowEmptyResults: true, testResults: '**/target/surefire-reports/*.xml'
                }
            }
        }
        
        stage('Build Docker Image') {
            steps {
                script {
                    echo "üê≥ Construyendo imagen Docker de ${SERVICE_NAME}..."
                    sh """
                        docker build -t ${SERVICE_NAME}:${BUILD_TAG} -f Dockerfile ..
                        docker tag ${SERVICE_NAME}:${BUILD_TAG} ${SERVICE_NAME}:latest
                    """
                }
            }
        }
        
        stage('Deploy to Kubernetes') {
            when { expression { params.DEPLOY_TO_K8S == true } }
            steps {
                script {
                    echo "‚ò∏Ô∏è Desplegando ${SERVICE_NAME} en Kubernetes..."
                    sh """
                        . /root/google-cloud-sdk/path.bash.inc
                        kubectl create namespace ${K8S_NAMESPACE} --dry-run=client -o yaml | kubectl apply -f -
                        kubectl apply -f ../k8s/microservices/${SERVICE_NAME}-deployment.yaml -n ${K8S_NAMESPACE}
                        kubectl rollout status deployment/${SERVICE_NAME} -n ${K8S_NAMESPACE} --timeout=180s || echo "‚ö†Ô∏è ${SERVICE_NAME} no est√° listo"
                    """
                }
            }
        }
        
        stage('Integration Tests') {
            when { expression { params.DEPLOY_TO_K8S == true } }
            steps {
                script {
                    echo "üß™ Ejecutando pruebas de integraci√≥n de ${SERVICE_NAME}..."
                    sh """
                        . /root/google-cloud-sdk/path.bash.inc
                        kubectl get pods -n ${K8S_NAMESPACE} -l app=${SERVICE_NAME}
                        POD_STATUS=\$(kubectl get pods -n ${K8S_NAMESPACE} -l app=${SERVICE_NAME} -o jsonpath='{.items[0].status.phase}' 2>/dev/null || echo 'NotFound')
                        if [ "\$POD_STATUS" = "Running" ]; then
                            echo "‚úÖ ${SERVICE_NAME} est√° corriendo correctamente"
                        else
                            echo "‚ö†Ô∏è WARNING: ${SERVICE_NAME} no est√° en estado Running"
                            exit 1
                        fi
                    """
                }
            }
        }
    }
    
    post {
        always { cleanWs() }
        success { echo "‚úÖ Pipeline de ${SERVICE_NAME} ejecutado exitosamente" }
        failure { echo "‚ùå Pipeline de ${SERVICE_NAME} fall√≥" }
    }
}
