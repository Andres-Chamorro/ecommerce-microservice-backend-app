pipeline {
    agent any
    
    environment {
        // Java Configuration
        JAVA_HOME = '/usr/lib/jvm/java-17-openjdk-amd64'
        PATH = "${JAVA_HOME}/bin:${env.PATH}"
        
        // Service Configuration
        SERVICE_NAME = 'product-service'
        SERVICE_PORT = '8500'
        
        // Build Configuration
        MAVEN_OPTS = '-Xmx2048m'
        BUILD_TAG = "${env.BUILD_NUMBER}"
        
        // Docker - Local para Minikube
        IMAGE_NAME = "${SERVICE_NAME}"
        
        // Minikube Configuration
        K8S_NAMESPACE = 'ecommerce-dev'
    }
    
    parameters {
        booleanParam(
            name: 'SKIP_TESTS',
            defaultValue: false,
            description: 'Saltar pruebas unitarias e integraciÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â³n'
        )
        booleanParam(
            name: 'SKIP_DEPLOY',
            defaultValue: false,
            description: 'Saltar despliegue en Minikube'
        )
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo "ÃƒÆ’Ã‚Â°Ãƒâ€¦Ã‚Â¸ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œÃƒÂ¢Ã¢â€šÂ¬Ã…Â¾ [DEV] Clonando repositorio de ${SERVICE_NAME}..."
                checkout scm
            }
        }
        
        stage('Build Maven') {
            steps {
                script {
                    echo "ÃƒÆ’Ã‚Â°Ãƒâ€¦Ã‚Â¸ÃƒÂ¢Ã¢â€šÂ¬Ã‚ÂÃƒâ€šÃ‚Â¨ [DEV] Compilando ${SERVICE_NAME} con Maven..."
                    dir('product-service') {
                        sh 'mvn clean package -DskipTests'
                    }
                }
            }
        }
        
        stage('Unit Tests') {
            when {
                expression { params.SKIP_TESTS == false }
            }
            steps {
                script {
                    echo "ÃƒÆ’Ã‚Â°Ãƒâ€¦Ã‚Â¸Ãƒâ€šÃ‚Â§Ãƒâ€šÃ‚Âª [DEV] Ejecutando pruebas unitarias de ${SERVICE_NAME}..."
                    dir('product-service') {
                        sh 'mvn test -Dtest=*ServiceTest,*ResourceTest'
                    }
                }
            }
            post {
                always {
                    junit allowEmptyResults: true, testResults: 'product-service/target/surefire-reports/*.xml'
                }
            }
        }
        
        stage('Build Docker Image') {
            steps {
                script {
                    echo "ÃƒÆ’Ã‚Â°Ãƒâ€¦Ã‚Â¸Ãƒâ€šÃ‚ÂÃƒâ€šÃ‚Â³ [DEV] Construyendo imagen Docker de ${SERVICE_NAME}..."
                    sh """
                        # Construir imagen directamente en Minikube
                        minikube image build -t ${IMAGE_NAME}:dev-${BUILD_TAG} -f product-service/Dockerfile .
                        minikube image build -t ${IMAGE_NAME}:dev-latest -f product-service/Dockerfile .
                        
                        # Verificar que la imagen existe
                        minikube image ls | grep ${IMAGE_NAME} || echo "WARNING: Imagen no encontrada"
                    """
                }
            }
        }
        
        stage('Deploy to Minikube') {
            when {
                expression { params.SKIP_DEPLOY == false }
            }
            steps {
                script {
                    echo "ÃƒÆ’Ã‚Â¢Ãƒâ€¹Ã…â€œÃƒâ€šÃ‚Â¸ÃƒÆ’Ã‚Â¯Ãƒâ€šÃ‚Â¸Ãƒâ€šÃ‚Â [DEV] Desplegando ${SERVICE_NAME} en Minikube..."
                    
                    sh """
                        # Configurar KUBECONFIG explÃ­citamente
                        export KUBECONFIG=/var/jenkins_home/.kube/config
                        
                        # Cambiar contexto a Minikube
                        kubectl config use-context minikube
                        
                        # Verificar conexiÃƒÂ³n
                        kubectl cluster-info
                        
                        # Crear namespace si no existe
                        kubectl create namespace ${K8S_NAMESPACE} --dry-run=client -o yaml | kubectl apply -f -
                        
                        # Crear deployment temporal para dev
                        cat <<EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ${SERVICE_NAME}
  namespace: ${K8S_NAMESPACE}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ${SERVICE_NAME}
  template:
    metadata:
      labels:
        app: ${SERVICE_NAME}
    spec:
      containers:
      - name: ${SERVICE_NAME}
        image: ${IMAGE_NAME}:dev-${BUILD_TAG}
        ports:
        - containerPort: ${SERVICE_PORT}
        imagePullPolicy: Never
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "dev"
---
apiVersion: v1
kind: Service
metadata:
  name: ${SERVICE_NAME}
  namespace: ${K8S_NAMESPACE}
spec:
  selector:
    app: ${SERVICE_NAME}
  ports:
  - port: ${SERVICE_PORT}
    targetPort: ${SERVICE_PORT}
  type: ClusterIP
EOF
                        
                        # Esperar a que el deployment estÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â© listo
                        kubectl rollout status deployment/${SERVICE_NAME} -n ${K8S_NAMESPACE} --timeout=180s || echo "ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã‚Â¡Ãƒâ€šÃ‚Â ÃƒÆ’Ã‚Â¯Ãƒâ€šÃ‚Â¸Ãƒâ€šÃ‚Â ${SERVICE_NAME} no estÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¡ listo"
                    """
                }
            }
        }
        
        stage('Verify Deployment') {
            when {
                expression { params.SKIP_DEPLOY == false }
            }
            steps {
                script {
                    echo "ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã¢â‚¬Å“ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ [DEV] Verificando despliegue de ${SERVICE_NAME}..."
                    
                    sh """
                        echo "ÃƒÆ’Ã‚Â°Ãƒâ€¦Ã‚Â¸ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œÃƒâ€¦Ã‚Â  Estado de pods:"
                        kubectl get pods -n ${K8S_NAMESPACE} -l app=${SERVICE_NAME}
                        
                        echo "ÃƒÆ’Ã‚Â°Ãƒâ€¦Ã‚Â¸ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œÃƒâ€¦Ã‚Â  Estado de servicios:"
                        kubectl get svc -n ${K8S_NAMESPACE} ${SERVICE_NAME}
                        
                        POD_STATUS=\$(kubectl get pods -n ${K8S_NAMESPACE} -l app=${SERVICE_NAME} -o jsonpath='{.items[0].status.phase}' 2>/dev/null || echo 'NotFound')
                        echo "Estado del pod: \$POD_STATUS"
                        
                        if [ "\$POD_STATUS" = "Running" ]; then
                            echo "ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã¢â‚¬Å“ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ ${SERVICE_NAME} estÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¡ corriendo correctamente en Minikube"
                        else
                            echo "ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã‚Â¡Ãƒâ€šÃ‚Â ÃƒÆ’Ã‚Â¯Ãƒâ€šÃ‚Â¸Ãƒâ€šÃ‚Â WARNING: ${SERVICE_NAME} no estÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¡ en estado Running"
                            exit 1
                        fi
                    """
                }
            }
        }
        
        stage('Integration Tests') {
            when {
                expression { params.SKIP_TESTS == false && params.SKIP_DEPLOY == false }
            }
            steps {
                script {
                    echo "ÃƒÆ’Ã‚Â°Ãƒâ€¦Ã‚Â¸ÃƒÂ¢Ã¢â€šÂ¬Ã‚ÂÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â [DEV] Ejecutando pruebas de integraciÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â³n..."
                    dir('tests/integration') {
                        sh '''
                            if [ -f pom.xml ]; then
                                # Configurar URLs de servicios en Minikube
                                export USER_SERVICE_URL="http://user-service.ecommerce-dev:8700"
                                export ORDER_SERVICE_URL="http://order-service.ecommerce-dev:8300"
                                export PRODUCT_SERVICE_URL="http://product-service.ecommerce-dev:8500"
                                
                                mvn test -Dtest=*IntegrationTest || echo "ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã‚Â¡Ãƒâ€šÃ‚Â ÃƒÆ’Ã‚Â¯Ãƒâ€šÃ‚Â¸Ãƒâ€šÃ‚Â Algunas pruebas de integraciÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â³n fallaron"
                            else
                                echo "ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¾Ãƒâ€šÃ‚Â¹ÃƒÆ’Ã‚Â¯Ãƒâ€šÃ‚Â¸Ãƒâ€šÃ‚Â No hay pruebas de integraciÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â³n configuradas"
                            fi
                        '''
                    }
                }
            }
        }
    }
    
    post {
        always {
            echo "ÃƒÆ’Ã‚Â°Ãƒâ€¦Ã‚Â¸Ãƒâ€šÃ‚Â§Ãƒâ€šÃ‚Â¹ [DEV] Limpiando workspace..."
            cleanWs()
        }
        success {
            echo """
            ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã¢â‚¬Å“ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ ========================================
            ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã¢â‚¬Å“ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ Pipeline DEV de ${SERVICE_NAME} completado
            ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã¢â‚¬Å“ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ ========================================
            ÃƒÆ’Ã‚Â°Ãƒâ€¦Ã‚Â¸ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œÃƒâ€šÃ‚Â¦ Imagen: ${IMAGE_NAME}:dev-${BUILD_TAG}
            ÃƒÆ’Ã‚Â¢Ãƒâ€¹Ã…â€œÃƒâ€šÃ‚Â¸ÃƒÆ’Ã‚Â¯Ãƒâ€šÃ‚Â¸Ãƒâ€šÃ‚Â  Namespace: ${K8S_NAMESPACE}
            ÃƒÆ’Ã‚Â°Ãƒâ€¦Ã‚Â¸Ãƒâ€¦Ã‚Â½Ãƒâ€šÃ‚Â¯ Ambiente: Minikube (Local)
            ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã¢â‚¬Å“ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ ========================================
            """
        }
        failure {
            echo "ÃƒÆ’Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒâ€¦Ã¢â‚¬â„¢ Pipeline DEV de ${SERVICE_NAME} fallÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â³"
        }
    }
}
